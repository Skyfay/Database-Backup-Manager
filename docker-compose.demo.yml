# DBackup Demo Environment
# =========================
# This docker-compose file sets up a complete demo environment for DBackup.
# It includes the main application, sample databases, and a reset mechanism.
#
# Usage:
#   docker-compose -f docker-compose.demo.yml up -d
#
# The demo instance:
# - Resets every 10 minutes (configurable)
# - Has pre-seeded database sources and backup jobs
# - Blocks sensitive operations (password change, user management, etc.)
#
# Default credentials:
#   Email: demo@dbackup.app
#   Password: demo123456

services:
  # ==========================================
  # Main Application
  # ==========================================
  dbackup:
    image: dbm:latest
    container_name: dbackup-demo
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Required secrets (generate new ones for production!)
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-09620f6de159004102697c34f050d7645e166b5b67505bab1c74f5c8e2ce696c}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-HxKboGLlSfd4Hfe+XyWpDF3c+dJRbE7tNho4TfT1jUg=}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-http://localhost:3000}

      # Demo Mode Configuration
      - DEMO_MODE=true
      - NEXT_PUBLIC_DEMO_MODE=true
      - DEMO_USER=demo@dbackup.app
      - DEMO_PASSWORD=demo123456

      # Logging
      - LOG_LEVEL=info
    volumes:
      - demo-db:/app/db
      - demo-backups:/backups
      - demo-storage:/app/storage
    depends_on:
      mysql-demo:
        condition: service_healthy
      postgres-demo:
        condition: service_healthy
      mongo-demo:
        condition: service_healthy
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Demo Databases
  # ==========================================

  # MySQL 8.0
  mysql-demo:
    image: mysql:8.0
    container_name: dbackup-demo-mysql
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: demorootpassword
      MYSQL_DATABASE: demo_app
      MYSQL_USER: demouser
      MYSQL_PASSWORD: demopassword
    ports:
      - "33306:3306"
    volumes:
      - mysql-demo-data:/var/lib/mysql
      - ./scripts/demo/mysql-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL 16
  postgres-demo:
    image: postgres:16-alpine
    container_name: dbackup-demo-postgres
    restart: always
    environment:
      POSTGRES_DB: demo_app
      POSTGRES_USER: demouser
      POSTGRES_PASSWORD: demopassword
    ports:
      - "54321:5432"
    volumes:
      - postgres-demo-data:/var/lib/postgresql/data
      - ./scripts/demo/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - demo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U demouser -d demo_app"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB 7.0
  mongo-demo:
    image: mongo:7.0
    container_name: dbackup-demo-mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: demorootpassword
      MONGO_INITDB_DATABASE: demo_app
    ports:
      - "27017:27017"
    volumes:
      - mongo-demo-data:/data/db
      - ./scripts/demo/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - demo-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Demo Reset Service
  # ==========================================
  # This service resets the demo environment periodically.
  # It resets: SQLite app database, backup files, AND demo databases.

  demo-reset:
    image: docker:cli
    container_name: dbackup-demo-reset
    restart: always
    volumes:
      - demo-db:/app/db
      - demo-backups:/backups
      - ./scripts/demo/seed.db:/seed/dbackup.db:ro
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount database volumes to clear data
      - mysql-demo-data:/mysql-data
      - postgres-demo-data:/postgres-data
      - mongo-demo-data:/mongo-data
    entrypoint: |
      sh -c '
        echo "Demo Reset Service Started"
        echo "Reset interval: Every 10 minutes (aligned to clock)"
        echo "Resets: App DB, Backups, MySQL, PostgreSQL, MongoDB"

        # Function to wait until next 10-minute mark
        wait_until_next_interval() {
          current_minute=$(date +%M | sed "s/^0//")
          current_second=$(date +%S | sed "s/^0//")

          # Calculate minutes until next 10-minute mark (00, 10, 20, 30, 40, 50)
          minutes_past=$((current_minute % 10))
          if [ $minutes_past -eq 0 ] && [ $current_second -lt 5 ]; then
            # We are at a 10-minute mark, wait for next one
            wait_seconds=600
          else
            minutes_to_wait=$((10 - minutes_past))
            wait_seconds=$(( (minutes_to_wait * 60) - current_second ))
          fi

          echo "[$(date)] Waiting ${wait_seconds} seconds until next reset..."
          sleep $wait_seconds
        }

        # Initial wait to align with clock
        echo "[$(date)] Aligning reset schedule with clock..."
        wait_until_next_interval

        while true; do
          echo "[$(date)] =========================================="
          echo "[$(date)] Starting full demo environment reset..."
          echo "[$(date)] =========================================="

          # Step 1: Stop DBackup first (prevent DB connections during reset)
          echo "[$(date)] Stopping DBackup..."
          docker stop dbackup-demo || true

          # Step 2: Stop all demo database containers
          echo "[$(date)] Stopping database containers..."
          docker stop dbackup-demo-mysql dbackup-demo-postgres dbackup-demo-mongo || true

          # Step 3: Clear database data (so init scripts run again on start)
          echo "[$(date)] Clearing MySQL data..."
          rm -rf /mysql-data/* 2>/dev/null || true

          echo "[$(date)] Clearing PostgreSQL data..."
          rm -rf /postgres-data/* 2>/dev/null || true

          echo "[$(date)] Clearing MongoDB data..."
          rm -rf /mongo-data/* 2>/dev/null || true

          # Step 4: Reset SQLite database
          echo "[$(date)] Resetting SQLite database..."
          rm -f /app/db/dbackup.db
          rm -f /app/db/dbackup.db-journal
          rm -f /app/db/dbackup.db-wal
          rm -f /app/db/dbackup.db-shm
          cp /seed/dbackup.db /app/db/dbackup.db
          chmod 644 /app/db/dbackup.db

          # Step 5: Clear backup files
          echo "[$(date)] Clearing backup files..."
          find /backups -type f -name "*.sql*" -delete 2>/dev/null || true
          find /backups -type f -name "*.tar*" -delete 2>/dev/null || true
          find /backups -type f -name "*.gz*" -delete 2>/dev/null || true
          find /backups -type f -name "*.enc*" -delete 2>/dev/null || true
          find /backups -type f -name "*.meta.json" -delete 2>/dev/null || true

          # Step 6: Start database containers (init scripts will recreate data)
          echo "[$(date)] Starting database containers..."
          docker start dbackup-demo-mysql dbackup-demo-postgres dbackup-demo-mongo

          # Step 7: Wait for databases to be ready
          echo "[$(date)] Waiting for databases to initialize (45s)..."
          sleep 45

          # Step 8: Start DBackup
          echo "[$(date)] Starting DBackup..."
          docker start dbackup-demo

          echo "[$(date)] =========================================="
          echo "[$(date)] Demo reset complete!"
          echo "[$(date)] =========================================="

          # Wait until next 10-minute mark
          wait_until_next_interval
        done
      '
    networks:
      - demo-network

# ==========================================
# Networks
# ==========================================
networks:
  demo-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  demo-db:
    name: dbackup-demo-db
  demo-backups:
    name: dbackup-demo-backups
  demo-storage:
    name: dbackup-demo-storage
  mysql-demo-data:
    name: dbackup-demo-mysql-data
  postgres-demo-data:
    name: dbackup-demo-postgres-data
  mongo-demo-data:
    name: dbackup-demo-mongo-data
